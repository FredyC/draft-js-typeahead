<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Draft Typeahead â€¢ Mentions</title>
</head>
<body>
  <div id="target"></div>
  <script src="../../node_modules/es6-shim/es6-shim.js"></script>
  <script src="../../node_modules/babel-transform-in-browser/dist/btib.js"></script>
  <script src="../../node_modules/immutable/dist/immutable.js"></script>
  <script src="../../node_modules/react/dist/react.js"></script>
  <script src="../../node_modules/react-dom/dist/react-dom.js"></script>
  <script src="../../node_modules/draft-js/dist/Draft.js"></script>
  <script src="../../dist/draft-typeahead.js"></script>
  <script type="text/es2015">
    'use strict';
    const { Editor, EditorState } = Draft;

    const MentionsTypeahead = ({ left, top, text }) => {
      const style = Object.assign({}, styles.typeahead, {
        position: 'absolute',
        left,
        top
      });

      return (
        <div style={style}>
          A wild overlay appears!
        </div>
      );
    };

    class MentionsEditorExample extends React.Component {
      constructor() {
        super();
        this.state = {
          editorState: EditorState.createEmpty()
        };
      }

      hasEntityAtSelection = () => {
        const { editorState } = this.state;

        const selection = editorState.getSelection();
        if (!selection.getHasFocus()) {
          return false;
        }

        const contentState = editorState.getCurrentContent();
        const block = contentState.getBlockForKey(selection.getStartKey());
        return !!block.getEntityAt(selection.getStartOffset() - 1);
      };

      getTypeaheadRange = () => {
        const selection = window.getSelection();
        if (selection.rangeCount === 0) {
          return null;
        }

        if (this.hasEntityAtSelection()) {
          return null;
        }

        const range = selection.getRangeAt(0);
        let text = range.startContainer.textContent;

        // Remove text that appears after the cursor..
        text = text.substring(0, range.startOffset);

        // ..and before the typeahead token.
        const index = text.lastIndexOf('@');
        if (index === -1) {
          return null;
        }
        text = text.substring(index);

        return {
          text,
          start: index,
          end: range.startOffset
        };
      };

      getTypeaheadState = () => {
        const typeaheadRange = this.getTypeaheadRange();
        if (!typeaheadRange) {
          return null;
        }

        const tempRange = window.getSelection().getRangeAt(0).cloneRange();
        tempRange.setStart(tempRange.startContainer, typeaheadRange.start);

        const rangeRect = tempRange.getBoundingClientRect();
        let [left, top] = [rangeRect.left, rangeRect.bottom];

        return {
          left,
          top,
          text: typeaheadRange.text
        };
      };

      onChange = (editorState) => {
        this.setState({ editorState });

        // Set typeahead visibility. Wait a frame to ensure that the cursor is
        // updated.
        window.requestAnimationFrame(() => {
          this.setState({
            typeahead: this.getTypeaheadState()
          })
        });
      };

      renderTypeahead = () => {
        const { typeahead } = this.state;
        if (!typeahead) {
          return null;
        }
        return <MentionsTypeahead {...typeahead} />;
      }

      render = () => {
        const { state } = this;
        return (
          <div style={styles.root}>
            {this.renderTypeahead()}
            <div style={styles.editor}>
              <Editor
                editorState={state.editorState}
                onChange={this.onChange}
              />
            </div>
          </div>
        )
      };
    }

    const styles = {
      root: {
        width: 600,
        padding: 20,
        fontFamily: 'Helvetica, sans-serif'
      },
      editor: {
        minHeight: 80,
        padding: 10,
        border: '1px solid #ccc'
      },
      typeahead: {
        padding: 10,
        background: 'ivory',
        border: '1px solid #ccc',
        borderRadius: 3
      }
    };

    ReactDOM.render(
      <MentionsEditorExample />,
      document.getElementById('target')
    );
  </script>
</body>
</html>
